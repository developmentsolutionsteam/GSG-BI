WITH ARTICULOS AS (
    SELECT A.ORGANIZATION_CODE,
        B.NAME ORGANIZATION,
        INV.ITEM_NUMBER ITEM,
        INV.DESCRIPTION DESCRIPTION_ITEM,
        UOMT.UNIT_OF_MEASURE,
        INV.ORGANIZATION_ID,
        INV.INVENTORY_ITEM_ID,
        INV.MIN_MINMAX_QUANTITY MINIMO,
        INV.MAX_MINMAX_QUANTITY MAXIMO,
        INV.LIST_PRICE_PER_UNIT,
        LOT.LOT_NUMBER,
        SER.SERIAL_NUMBER
    FROM EGP_SYSTEM_ITEMS INV,
        INV_UNITS_OF_MEASURE_TL UOMT,
        INV_UNITS_OF_MEASURE_B UOMB,
        INV_ORG_PARAMETERS A,
        HR_ORGANIZATION_UNITS_F_TL B,
        INV_LOT_NUMBERS LOT,
        INV_SERIAL_NUMBERS SER
    WHERE 1 = 1
        AND B.ORGANIZATION_ID = INV.ORGANIZATION_ID
        AND A.ORGANIZATION_ID = INV.ORGANIZATION_ID
        --UNIDAD
        AND UOMB.UOM_CODE = INV.PRIMARY_UOM_CODE
        AND UOMT.UNIT_OF_MEASURE_ID = UOMB.UNIT_OF_MEASURE_ID
        AND UOMT.LANGUAGE = 'US'
        --LOTE
        AND INV.INVENTORY_ITEM_ID = LOT.INVENTORY_ITEM_ID (+)
        AND INV.ORGANIZATION_ID = LOT.ORGANIZATION_ID (+)
        --SERIE
        AND INV.INVENTORY_ITEM_ID = SER.INVENTORY_ITEM_ID (+)
        AND INV.ORGANIZATION_ID = SER.CURRENT_ORGANIZATION_ID (+)
        AND INV.ITEM_NUMBER IN ('3503000027', '0316000020', '0904000012')
        AND B.LANGUAGE = 'US'
),
CATEGORIA AS (
    SELECT ART.ORGANIZATION_ID,
        ART.INVENTORY_ITEM_ID,
        C.CATEGORY_ID,
        ECT.CATEGORY_NAME,
        ECSB.CATALOG_CODE
    FROM ARTICULOS ART,
        EGP_ITEM_CATEGORIES C,
        EGP_CATEGORIES_TL ECT,
        EGP_CATEGORY_SETS_B ECSB
    WHERE 1 = 1
        AND ART.ORGANIZATION_ID = C.ORGANIZATION_ID (+)
        AND ART.INVENTORY_ITEM_ID = C.INVENTORY_ITEM_ID (+)
        AND ECT.CATEGORY_ID = C.CATEGORY_ID
        AND ECT.LANGUAGE = 'US'
        AND C.CATEGORY_SET_ID = ECSB.CATEGORY_SET_ID(+)
    GROUP BY ART.ORGANIZATION_ID,
        ART.INVENTORY_ITEM_ID,
        C.CATEGORY_ID,
        ECT.CATEGORY_NAME,
        ECSB.CATALOG_CODE
),
CANTIDAD AS (
    SELECT Q.INVENTORY_ITEM_ID,
        Q.ORGANIZATION_ID,
        LOC.SEGMENT1,
        Q.SUBINVENTORY_CODE,
        ROUND(SUM(Q.PRIMARY_TRANSACTION_QUANTITY), 3) CANTIDAD
    FROM INV_ONHAND_QUANTITIES_DETAIL Q,
        ARTICULOS ART,
        INV_ITEM_LOCATIONS LOC
    WHERE 1 = 1
        AND ART.ORGANIZATION_ID = Q.ORGANIZATION_ID (+)
        AND ART.INVENTORY_ITEM_ID = Q.INVENTORY_ITEM_ID (+)
        AND Q.LOCATOR_ID = LOC.INVENTORY_LOCATION_ID(+)
        AND Q.ORGANIZATION_ID = LOC.ORGANIZATION_ID (+)
        AND Q.SUBINVENTORY_CODE IS NOT NULL
    GROUP BY Q.INVENTORY_ITEM_ID,
        Q.ORGANIZATION_ID,
        LOC.SEGMENT1,
        Q.SUBINVENTORY_CODE
),
COSTO AS (
    SELECT DISTINCT ROUND(CPC.UNIT_COST_AVERAGE, 4) COSTO_TOTAL,
        CPC.COST_DATE,
        CPC.INVENTORY_ITEM_ID,
        ULT_COST.INVENTORY_ORG_ID
    FROM CST_PERPAVG_COST CPC,
        (
            SELECT MAX(CPC.COST_DATE) COST_DATE,
                CPC.INVENTORY_ITEM_ID,
                CT.INVENTORY_ORG_ID,
                CPC.VAL_UNIT_ID,
                CPC.COST_BOOK_ID
            FROM CST_PERPAVG_COST CPC,
                CST_TRANSACTIONS CT,
                CST_COST_BOOKS_B CCB,
                ARTICULOS ART
            WHERE 1 = 1
                AND CPC.INVENTORY_ITEM_ID = ART.INVENTORY_ITEM_ID
                AND CT.INVENTORY_ORG_ID = ART.ORGANIZATION_ID
                AND CPC.TRANSACTION_ID = CT.TRANSACTION_ID
                AND CPC.COST_BOOK_ID = CCB.COST_BOOK_ID
                AND CCB.COST_BOOK_CODE = 'GCG_CST_LIB_NIIF'
            GROUP BY CPC.INVENTORY_ITEM_ID,
                CT.INVENTORY_ORG_ID,
                CPC.VAL_UNIT_ID,
                CPC.COST_BOOK_ID
        ) ULT_COST
    WHERE 1 = 1
        AND CPC.COST_DATE (+) = ULT_COST.COST_DATE
        AND CPC.INVENTORY_ITEM_ID = ULT_COST.INVENTORY_ITEM_ID
        AND CPC.VAL_UNIT_ID = ULT_COST.VAL_UNIT_ID
)
SELECT ART.*,
    CA.SUBINVENTORY_CODE,
    CA.CANTIDAD,
    CA.SEGMENT1,
    CAT1.CATEGORY_NAME AS CAT_COMPRAS,
    CAT2.CATEGORY_NAME AS CAT_INVENTARIOS,
    CAT3.CATEGORY_NAME AS CAT_COSTOS,
    CT.COSTO_TOTAL,
    CT.COST_DATE
FROM ARTICULOS ART,
    CANTIDAD CA,
    CATEGORIA CAT1,
    CATEGORIA CAT2,
    CATEGORIA CAT3,
    COSTO CT
WHERE 1 = 1
    AND CA.ORGANIZATION_ID = ART.ORGANIZATION_ID (+)
    AND CA.INVENTORY_ITEM_ID = ART.INVENTORY_ITEM_ID(+)
    AND ART.ORGANIZATION_ID = CAT1.ORGANIZATION_ID (+)
    AND ART.INVENTORY_ITEM_ID = CAT1.INVENTORY_ITEM_ID (+)
    AND CAT1.CATALOG_CODE = 'CAT_COMPRAS'
    AND ART.ORGANIZATION_ID = CAT2.ORGANIZATION_ID (+)
    AND ART.INVENTORY_ITEM_ID = CAT2.INVENTORY_ITEM_ID (+)
    AND CAT2.CATALOG_CODE = 'CAT_INVENTARIOS'
    AND ART.ORGANIZATION_ID = CAT3.ORGANIZATION_ID (+)
    AND ART.INVENTORY_ITEM_ID = CAT3.INVENTORY_ITEM_ID (+)
    AND CAT3.CATALOG_CODE = 'CAT_COSTOS'
    AND ART.ORGANIZATION_ID = CT.INVENTORY_ORG_ID (+)
    AND ART.INVENTORY_ITEM_ID = CT.INVENTORY_ITEM_ID (+)
